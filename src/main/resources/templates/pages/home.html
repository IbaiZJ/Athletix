<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/appLayout}"
  th:with="activePage='Home'"
>
  <head>
    <title th:text="#{home.title} + ${session.user.username}"></title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/regression@2.0.1/dist/regression.min.js"></script>
  </head>
  <body>
    <main layout:fragment="content" class="p-6">
      <div class="flex gap-4 flex-col md:flex-row">
        <div class="w-full md:w-65/100">
          <h1
            class="text-4xl font-bold text-gray-800"
            th:text="#{home.welcome} +'  ' + ${session.user.username} "
          ></h1>
        </div>

        <div class="w-full md:w-35/100">
          <h2 th:text="#{home.monthlyProgress}" class="text-xl font-semibold text-gray-700 mb-4"></h2>
          <canvas id="myChart" class="h-64 w-full"></canvas>
        </div>
      </div>

      <!-- Nuevo gráfico de regresión lineal -->
      <div class="mt-8">
        <h2 th:text="#{home.regression}" class="text-xl font-semibold text-gray-700 mb-4"></h2>
        <canvas id="regressionChart" class="h-64 w-full"></canvas>
      </div>
    </main>
  </body>
</html>

<!-- Datos desde Thymeleaf -->
<script th:inline="javascript">
  monthlyKm = {"Ene": 25, "Feb": 37, "Mar": 32};
  // Datos de ejemplo: ritmo medio en minutos por km cada mes
  monthlyPace = {"Ene": 5.2, "Feb": 4.9, "Mar": 5.1};
</script>

<!-- Script del gráfico original (no modificado) -->
<script type="module">
  import { ChartBuilder } from '/js/charts/ChartBuilder.js';
  import { getLineChartConf } from '/js/charts/chartTypes/lineChart.js';

  const etiquetas = Object.keys(monthlyKm);
  const datos = Object.values(monthlyKm);

  const config = getLineChartConf(etiquetas, datos, 'KM por mes');
  ChartBuilder.createLine('myChart', config);
</script>

<!-- Script del nuevo gráfico de regresión lineal -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Preparar datos para la regresión (km vs tiempo por km)
    const meses = Object.keys(monthlyKm);
    const kmData = Object.values(monthlyKm);
    const paceData = Object.values(monthlyPace);

    // Formatear datos para la librería de regresión
    const regressionData = kmData.map((km, index) => [km, paceData[index]]);

    // Calcular regresión lineal (y = ax + b)
    const result = regression.linear(regressionData);
    const [a, b] = result.equation; // y = a*x + b

    // Generar puntos para la línea de tendencia
    const minKm = Math.min(...kmData);
    const maxKm = Math.max(...kmData);
    const trendLine = [
      { x: minKm, y: a * minKm + b },
      { x: maxKm, y: a * maxKm + b }
    ];

    // Configurar Chart.js
    const ctx = document.getElementById('regressionChart').getContext('2d');
    new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [
          {
            label: 'Datos reales',
            data: kmData.map((km, index) => ({ x: km, y: paceData[index] })),
            backgroundColor: 'rgba(75, 192, 192, 1)',
            pointRadius: 8
          },
          {
            label: 'Línea de tendencia',
            data: trendLine,
            type: 'line',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            showLine: true
          }
        ]
      },
      options: {
        scales: {
          x: {
            title: {
              display: true,
              text: 'Kilómetros mensuales'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Tiempo por km (min)'
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: (context) => {
                if (context.datasetIndex === 0) {
                  return `Mes: ${meses[context.dataIndex]} | ${context.parsed.y} min/km`;
                }
                return `Tendencia: ${context.parsed.y.toFixed(2)} min/km`;
              }
            }
          },
          annotation: {
            annotations: {
              line1: {
                type: 'line',
                yMin: b,
                yMax: b,
                borderColor: 'rgb(255, 99, 132)',
                borderWidth: 2,
                label: {
                  content: `Ecuación: y = ${a.toFixed(4)}x + ${b.toFixed(2)}`,
                  enabled: true,
                  position: 'right'
                }
              }
            }
          }
        }
      }
    });

    // Mostrar predicción en consola (opcional)
    console.log(`Ecuación de regresión: y = ${a.toFixed(4)}x + ${b.toFixed(2)}`);
    console.log('Predicción: A más km, el tiempo por km debería ser ~' + (a < 0 ? 'menor' : 'mayor'));
  });
</script>